<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>基于 Proxmox VE 的 All in One 服务器搭建 - Centaurus99 的杂物堆</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Centaurus99 的杂物堆"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Centaurus99 的杂物堆"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="树莓派挂在宿舍当软路由已经两年了，大部分情况下都挺好用，透明代理体验也还算尚可。 然而由于使用的 USB 无线网卡驱动支持较差，无线峰值速率只能跑到 200+ Mbps，且不大稳定。并且树莓派性能不高，无法开设一些高负载服务。另外，树莓派作为路由常年开启，需要考虑散热问题，虽然给使用的小风扇写了启停功能，但是启动运转时还是会有一定的噪音，较为恼人。"><meta property="og:type" content="article"><meta property="og:title" content="基于 Proxmox VE 的 All in One 服务器搭建"><meta property="og:url" content="https://blog.centaurus99.com/2023/06/17/%E5%9F%BA%E4%BA%8E-Proxmox-VE-%E7%9A%84-All-in-One-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/"><meta property="og:site_name" content="Centaurus99 的杂物堆"><meta property="og:description" content="树莓派挂在宿舍当软路由已经两年了，大部分情况下都挺好用，透明代理体验也还算尚可。 然而由于使用的 USB 无线网卡驱动支持较差，无线峰值速率只能跑到 200+ Mbps，且不大稳定。并且树莓派性能不高，无法开设一些高负载服务。另外，树莓派作为路由常年开启，需要考虑散热问题，虽然给使用的小风扇写了启停功能，但是启动运转时还是会有一定的噪音，较为恼人。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.centaurus99.com/2023/06/17/%E5%9F%BA%E4%BA%8E-Proxmox-VE-%E7%9A%84-All-in-One-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/proxmox-logo.svg"><meta property="article:published_time" content="2023-06-17T11:12:49.000Z"><meta property="article:modified_time" content="2025-10-08T09:26:50.000Z"><meta property="article:author" content="Centaurus99"><meta property="article:tag" content="软路由"><meta property="article:tag" content="PVE"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.centaurus99.com/2023/06/17/%E5%9F%BA%E4%BA%8E-Proxmox-VE-%E7%9A%84-All-in-One-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/proxmox-logo.svg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.centaurus99.com/2023/06/17/%E5%9F%BA%E4%BA%8E-Proxmox-VE-%E7%9A%84-All-in-One-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/"},"headline":"基于 Proxmox VE 的 All in One 服务器搭建","image":[],"datePublished":"2023-06-17T11:12:49.000Z","dateModified":"2025-10-08T09:26:50.000Z","author":{"@type":"Person","name":"Centaurus99"},"publisher":{"@type":"Organization","name":"Centaurus99 的杂物堆","logo":{"@type":"ImageObject"}},"description":"树莓派挂在宿舍当软路由已经两年了，大部分情况下都挺好用，透明代理体验也还算尚可。 然而由于使用的 USB 无线网卡驱动支持较差，无线峰值速率只能跑到 200+ Mbps，且不大稳定。并且树莓派性能不高，无法开设一些高负载服务。另外，树莓派作为路由常年开启，需要考虑散热问题，虽然给使用的小风扇写了启停功能，但是启动运转时还是会有一定的噪音，较为恼人。"}</script><link rel="canonical" href="https://blog.centaurus99.com/2023/06/17/%E5%9F%BA%E4%BA%8E-Proxmox-VE-%E7%9A%84-All-in-One-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/"><link rel="alternate" href="/atom.xml" title="Centaurus99 的杂物堆" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.loli.net/ajax/libs/pace/1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-2-column"><script type="text/javascript" src="/js/imaegoo/night.js"></script><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Centaurus99 的杂物堆</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">时间轴</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>基于 Proxmox VE 的 All in One 服务器搭建</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="2023-06-17T11:12:49.000Z" title="2023-06-17T11:12:49.000Z">2023-06-17</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="2025-10-08T09:26:50.000Z" title="2025-10-08T09:26:50.000Z">2025-10-08</time></span><span class="level-item"><i class="far fa-folder-open has-text-grey"></i> <a class="link-muted" href="/categories/%E6%8A%98%E8%85%BE/">折腾</a></span><span class="level-item"><i class="far fa-clock"></i> 1 小时读完 (大约9314个字)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><div class="content"><p>树莓派挂在宿舍当软路由已经两年了，大部分情况下都挺好用，透明代理体验也还算尚可。</p>
<p>然而由于使用的 USB 无线网卡驱动支持较差，无线峰值速率只能跑到 200+ Mbps，且不大稳定。并且树莓派性能不高，无法开设一些高负载服务。另外，树莓派作为路由常年开启，需要考虑散热问题，虽然给使用的小风扇写了启停功能，但是启动运转时还是会有一定的噪音，较为恼人。</p>
<span id="more"></span>

<p>正好快到暑假了，需要开设一台 MC 服务器，于是打算换用一台较高性能的软路由，再配合 Wi-Fi 6 无线路由器作为 AP，提供高速率、高稳定性的有线无线网络接入。</p>
<h2 id="整体配置概览"><a href="#整体配置概览" class="headerlink" title="整体配置概览"></a>整体配置概览</h2><h3 id="软路由"><a href="#软路由" class="headerlink" title="软路由"></a>软路由</h3><p>选用畅网奔腾 8505 软路由，1 大核 + 4 小核，大核的单核性能较高，CPU-Z 单核跑分相比我的笔记本（i5-1135G7）高出约 40%，可以用来开设一些吃单核性能的服务。</p>
<p>内存使用了两条光威 8GB DDR4 3200 内存，时序 CL-22-22-22-52。使用 16 GB 内存也主要是为了开设 MC 服务器考虑。</p>
<p>存储方面安装了西数 SN570 1T 固态作为系统盘，也暂时承担一部分文件存储功能。</p>
<p>作为一台路由器，这台软路由有 6 个 Intel i226-V 2.5G 网卡，即使以后有更多设备需要有线接入，也不一定需要增设交换机。</p>
<p>功耗方面，实测待机时输入功率约为 10 W。</p>
<p>温度方面，室温 24 度环境下，不加风扇待机时 CPU 约 40 度，NVME 固态约 50 度，软路由表面摸起来较热；加上赠送的 USB 12cm 风扇吹顶部铝制散热片后，待机时 CPU 约 30 度，NVME 固态约 40 度，外壳很凉快。</p>
<h3 id="无线-AP"><a href="#无线-AP" class="headerlink" title="无线 AP"></a>无线 AP</h3><p>目前廉价的 Wi-Fi 6 路由器均使用千兆有线网口，单口有线速率甚至可能不及无线速率，故考虑需要能和软路由之间做链路聚合提高内网性能。</p>
<p>调查后发现，TP-Link 系列的路由器似乎原厂固件就有着端口聚合功能，其子品牌水星也有着相同的功能，且便宜几十元。</p>
<p>于是选用水星 X306G 路由器，AX3000 规格，计划只使用其 5G 频段 Wi-Fi 和端口聚合功能，运行在 AP 模式。</p>
<h2 id="安装和调试-PVE"><a href="#安装和调试-PVE" class="headerlink" title="安装和调试 PVE"></a>安装和调试 PVE</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>参考官方教程或网上教程，一路 next 即可。</p>
<p>其中将 ETH5 对应的网卡设为管理口，静态 IP 设为 <code>192.168.22.100</code>（22 网段）。</p>
<h3 id="更换内核版本"><a href="#更换内核版本" class="headerlink" title="更换内核版本"></a>更换内核版本</h3><p>由于 8505 CPU 是大小核架构，建议使用较新的内核获取大小核调度优化。</p>
<p>先换源，参考：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/proxmox/">https://mirrors.tuna.tsinghua.edu.cn/help/proxmox/</a>，并删除企业源：<code>rm /etc/apt/sources.list.d/pve-install-repo.list</code></p>
<p><code>apt update</code> 后搜索可用的内核版本，我这儿选择 6.2 版本：<code>apt install pve-kernel-6.2</code>，安装完重启后生效。</p>
<p>可以使用 <code>proxmox-boot-tool</code> 管理安装的以及用于启动的 kernel 版本。</p>
<h3 id="管理页面添加温度显示"><a href="#管理页面添加温度显示" class="headerlink" title="管理页面添加温度显示"></a>管理页面添加温度显示</h3><p>偷懒使用了恩山论坛的脚本，添加了温度，CPU频率，硬盘信息的显示：<a target="_blank" rel="noopener" href="https://www.right.com.cn/forum/thread-6754687-1-1.html">https://www.right.com.cn/forum/thread-6754687-1-1.html</a></p>
<h3 id="删除-lvm-thin-并扩容-lvm"><a href="#删除-lvm-thin-并扩容-lvm" class="headerlink" title="删除 lvm-thin 并扩容 lvm"></a>删除 lvm-thin 并扩容 lvm</h3><p>由于使用单盘搭建 All in One 服务器，计划在 PVE 系统中使用 samba 共享数据文件，因此需要较大的 lvm 空间。同时，由于不需要开大量的虚拟机，也用不到 lvm-thin 的特性。故将 lvm-thin 的空间全部合入 lvm 中。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://foxi.buduanwang.vip/virtualization/pve/1434.html/">https://foxi.buduanwang.vip/virtualization/pve/1434.html/</a></p>
<p>删除 lvm-thin：<code>lvremove /dev/pve/data</code></p>
<p>扩容 lvm：<code>lvextend -rl +100%FREE /dev/pve/root</code></p>
<h3 id="部署-samba"><a href="#部署-samba" class="headerlink" title="部署 samba"></a>部署 samba</h3><p>安装：<code>apt update &amp;&amp; apt install samba</code></p>
<p>添加用户：<code>useradd thx</code></p>
<p>将用户添加到 samba：<code>smbpasswd -a thx</code></p>
<p>编辑 samba 配置文件 <code>/etc/samba/smb.conf</code>，添加共享文件夹的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[RaspCloud]</span><br><span class="line">    path = /data/RaspCloud</span><br><span class="line">    writeable = yes</span><br><span class="line">    create mask = 0777</span><br><span class="line">    directory mask = 1777</span><br><span class="line">    public = yes</span><br><span class="line">    guest ok = yes</span><br><span class="line"></span><br><span class="line">[PT]</span><br><span class="line">    path = /data/PT</span><br><span class="line">    writeable = yes</span><br><span class="line">    create mask = 0644</span><br><span class="line">    directory mask = 1755</span><br><span class="line">    public = yes</span><br><span class="line">    guest ok = yes</span><br><span class="line"></span><br><span class="line">[Private]</span><br><span class="line">    path = /data/Private</span><br><span class="line">    writeable = yes</span><br><span class="line">    create mask = 0644</span><br><span class="line">    directory mask = 1755</span><br><span class="line">    public = no</span><br><span class="line">    guest ok = no</span><br><span class="line">    valid users = thx</span><br><span class="line">    browseable = yes</span><br><span class="line"></span><br><span class="line">[Sync]</span><br><span class="line">    path = /data/Sync</span><br><span class="line">    writeable = yes</span><br><span class="line">    create mask = 0644</span><br><span class="line">    directory mask = 1755</span><br><span class="line">    public = no</span><br><span class="line">    guest ok = no</span><br><span class="line">    valid users = thx</span><br><span class="line">    browseable = yes</span><br></pre></td></tr></table></figure>

<p>其中 <code>/data/RaspCloud</code> 为公开共享目录，内部有 <code>read-only</code> 目录通过改变目录所有者来限制 guest 的写入。</p>
<p><code>/data/PT</code> 为公开只读共享目录。</p>
<p><code>/data/Private</code> 和 <code>/data/Sync</code> 为私密目录，使用白名单限制访问用户。</p>
<p>如果需要在共享目录中软链接到系统里的其它目录中，则需要在 <code>[global]</code> 段中添加：</p>
<figure class="highlight plaintext"><figcaption><span>/etc/samba/smb.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">   follow symlinks = yes</span><br><span class="line">   wide links = yes</span><br><span class="line">   unix extensions = no</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/humanking7/article/details/85058471">https://blog.csdn.net/humanking7/article/details/85058471</a></p>
<p><code>smb.conf</code> 中的配置项可查阅：<a target="_blank" rel="noopener" href="https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html">https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html</a></p>
<h3 id="更改-CPU-电源策略"><a href="#更改-CPU-电源策略" class="headerlink" title="更改 CPU 电源策略"></a>更改 CPU 电源策略</h3><p>作为一个桌面服务器，需要考虑到功耗与发热的问题。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://pve.sqlsec.com/4/6/">https://pve.sqlsec.com/4/6/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看支持的 CPU 电源模式</span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors</span><br><span class="line"></span><br><span class="line"># 查看当前的 CPU 电源模式</span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">电源模式</th>
<th align="left">解释说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">performance</td>
<td align="left">性能模式，将 CPU 频率固定工作在其支持的较高运行频率上，而不动态调节。</td>
</tr>
<tr>
<td align="left">userspace</td>
<td align="left">系统将变频策略的决策权交给了用户态应用程序，较为灵活。</td>
</tr>
<tr>
<td align="left">powersave</td>
<td align="left">省电模式，CPU 会固定工作在其支持的最低运行频率上。</td>
</tr>
<tr>
<td align="left">ondemand</td>
<td align="left">按需快速动态调整 CPU 频率，没有负载的时候就运行在低频，有负载就高频运行。</td>
</tr>
<tr>
<td align="left">conservative</td>
<td align="left">与 ondemand 不同，平滑地调整 CPU 频率，频率的升降是渐变式的，稍微缓和一点。</td>
</tr>
<tr>
<td align="left">schedutil</td>
<td align="left">负载变化回调机制，后面新引入的机制，通过触发 schedutil <code>sugov_update</code> 进行调频动作。</td>
</tr>
</tbody></table>
<p>安装工具：<code>apt install cpufrequtils</code></p>
<p>设为 <code>ondemand</code> 模式：<code>cpufreq-set -g ondemand</code></p>
<h3 id="无显示器启动问题"><a href="#无显示器启动问题" class="headerlink" title="无显示器启动问题"></a>无显示器启动问题</h3><p>发现如果不接显示器，则无法正常启动。初步判断在启动 grub 或之后出现问题。</p>
<p>然而，对 BIOS 和 grub 配置文件做各种修改之后也无法解决问题。</p>
<p>最终打算网上买个 HDMI 诱骗器插上得了。</p>
<p>插上后也没用。</p>
<p>经仔细排查（偶然将接地良好的显示器的 Type-C 线的外壳接触到软路由 Type-C 口的外壳上，发现问题就消失了），发现是供电接地问题。</p>
<p>先前为了监测功耗，我将电源的 DC 转为了 USB 母口，插上了 USB 电压电流测量设备，再将测量设备的 USB 口转为 DC 口，接到软路由的 DC 供电口。在这个过程中可能丢失了地线。</p>
<p>直接接电源就不再有问题。</p>
<h3 id="挂载硬盘"><a href="#挂载硬盘" class="headerlink" title="挂载硬盘"></a>挂载硬盘</h3><p>再接上一块老机械盘，用来挂 PT。</p>
<p>安装好硬盘后，先使用 <code>lsblk -f</code> 或者 <code>ls -l /dev/disk/by-uuid</code> 找到分区的 UUID，使用 UUID 进行挂载可以避免 <code>/dev/</code> 下设备名的改变导致的挂载问题。</p>
<p>然后在 <code>/etc/fstab</code> 中添加挂载信息：</p>
<figure class="highlight plaintext"><figcaption><span>/etc/fstab</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID=1f4a2672-3039-594b-808c-a5d3913b0fde /data/hdd ext4 defaults,nofail 0 0</span><br></pre></td></tr></table></figure>

<p>注意 <code>nofail</code> 用来在硬盘没有成功挂载时也能正常启动，否则启动会等待硬盘挂载，失败后进入 emergency mode。</p>
<p>然后 <code>mount -a</code> 生效，开机后也会自动挂载。</p>
<h3 id="硬盘维护"><a href="#硬盘维护" class="headerlink" title="硬盘维护"></a>硬盘维护</h3><h4 id="缩减数据盘的文件系统预留空间"><a href="#缩减数据盘的文件系统预留空间" class="headerlink" title="缩减数据盘的文件系统预留空间"></a>缩减数据盘的文件系统预留空间</h4><p>参考：<a target="_blank" rel="noopener" href="https://askubuntu.com/questions/249387/df-h-used-space-avail-free-space-is-less-than-the-total-size-of-home">https://askubuntu.com/questions/249387/df-h-used-space-avail-free-space-is-less-than-the-total-size-of-home</a></p>
<p>默认情况下，<code>df -h</code> 查看硬盘空间会发现，<code>Size</code> 会大于 <code>Used</code> + <code>Avail</code>，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Filesystem            Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda1             294G  261G   19G  94% /data/hdd</span><br></pre></td></tr></table></figure>

<p>这是由于 <code>ext2/3/4</code> 文件系统默认会保留 5% 的空间只供 root 使用，而数据盘就没这个必要了，可以 <code>tune2fs -m 0 /dev/sda1</code> 来取消预留空间。</p>
<h4 id="S-M-A-R-T-信息"><a href="#S-M-A-R-T-信息" class="headerlink" title="S.M.A.R.T. 信息"></a>S.M.A.R.T. 信息</h4><p>在 WebUI 中，可以在节点的磁盘一栏中查看 S.M.A.R.T. 信息。</p>
<p>命令行中，可以使用 <code>smartctl -a /dev/sda</code> 查看。</p>
<p>S.M.A.R.T. 信息的解析，可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/MrSate/article/details/88564764">https://blog.csdn.net/MrSate/article/details/88564764</a>。</p>
<p>使用 <code>journalctl -u smartmontools.service</code> 可以查看 smartmontools 守护进程的监测日志。</p>
<h4 id="配置-smartd-守护程序"><a href="#配置-smartd-守护程序" class="headerlink" title="配置 smartd 守护程序"></a>配置 smartd 守护程序</h4><p>还可以在 <code>/etc/smartd.conf</code> 中配置守护程序，初始时配置如下：</p>
<figure class="highlight plaintext"><figcaption><span>/etc/smartd.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEVICESCAN -d removable -n standby -m root -M exec /usr/share/smartmontools/smartd-runner</span><br></pre></td></tr></table></figure>

<p>添加如下参数：</p>
<ul>
<li>基于默认修改的监测与报警参数 <code>-H -f -l error -l selftest -C 197 -U 198</code>，相比默认的 <code>-a</code> 参数减少了等效的 <code>-t</code> 参数，否则每半小时都会在日志中输出 S.M.A.R.T. 信息的变化情况（详见 <code>/etc/smartd.conf</code> 中的说明）</li>
<li>每周六凌晨三点短自检，每月二十号凌晨三点长自检：<code>-s (S/../../6/03/|L/../20/./03)</code></li>
<li>监控温度，在温度变化 5 度时记录，达到 40 度时记录，达到 45 度时警告（0 为关闭）：<code>-W 5,40,45</code></li>
</ul>
<p>修改后如下：</p>
<figure class="highlight plaintext"><figcaption><span>/etc/smartd.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DEFAULT -H -f -l error -l selftest -d removable -n standby -m root -M exec /usr/share/smartmontools/smartd-runner</span><br><span class="line">/dev/nvme0 -W 0,60,70</span><br><span class="line">DEVICESCAN -C 197 -U 198 -s (S/../../6/03/|L/../20/./03) -W 0,40,50</span><br></pre></td></tr></table></figure>

<p>重启服务后生效：<code>systemctl restart smartd.service</code></p>
<p>如果守护程序检测到了出现问题，也会给安装 PVE 时填写的邮箱发邮件，实测 QQ 邮箱可以收到。</p>
<p>参考：</p>
<ul>
<li><code>man smartd.conf</code></li>
<li><a target="_blank" rel="noopener" href="https://blog.kahosan.top/2022/06/20/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20smartd%20%E7%9B%91%E6%8E%A7%E4%BD%A0%E7%9A%84%E7%A1%AC%E7%9B%98/">https://blog.kahosan.top/2022/06/20/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%20smartd%20%E7%9B%91%E6%8E%A7%E4%BD%A0%E7%9A%84%E7%A1%AC%E7%9B%98/</a></li>
<li><a target="_blank" rel="noopener" href="https://forum.proxmox.com/threads/seagate-smart-prefailure-attribute.57454/">https://forum.proxmox.com/threads/seagate-smart-prefailure-attribute.57454/</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/S.M.A.R.T.#smartd">https://wiki.archlinux.org/title/S.M.A.R.T.#smartd</a></li>
</ul>
<h4 id="配置硬盘休眠"><a href="#配置硬盘休眠" class="headerlink" title="配置硬盘休眠"></a>配置硬盘休眠</h4><p>可能需要先关闭 <code>pvestatd</code> 对硬盘的扫描，参考：<a target="_blank" rel="noopener" href="https://www.ippa.top/954.html">https://www.ippa.top/954.html</a></p>
<p>先 <code>ls -l /dev/disk/by-uuid</code> 找到硬盘的 UUID <code>1f4a2672-3039-594b-808c-a5d3913b0fde</code>，然后编辑 <code>/etc/lvm/lvm.conf</code>，在 <code>global_filter</code> 中添加 <code>&quot;r|/dev/disk/by-uuid/1f4a2672-3039-594b-808c-a5d3913b0fde.*|&quot;</code>，结果如下：</p>
<figure class="highlight plaintext"><figcaption><span>/etc/lvm/lvm.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">devices &#123;</span><br><span class="line">    global_filter=[&quot;r|/dev/zd.*|&quot;, &quot;r|/dev/disk/by-uuid/1f4a2672-3039-594b-808c-a5d3913b0fde.*|&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pvestatd restart</code> 后生效。</p>
<p>查看硬盘当前状态：<code>smartctl -i -n standby /dev/sda | grep &quot;mode&quot;|awk &#39;&#123;print $4&#125;&#39;</code>，ACTIVE 或者 IDLE 都为运转状态。</p>
<p>查询当前电源管理参数：<code>hdparm -B /dev/sda</code></p>
<p>进入 <code>standby mode</code>：<code>hdparm -y /dev/sda</code></p>
<p>进入 <code>sleep mode</code>：<code>hdparm -Y /dev/sda</code></p>
<p>然后编辑 <code>/etc/hdparm.conf</code>，添加需要休眠的硬盘设置，比如十分钟后 standby 如下配置：</p>
<figure class="highlight plaintext"><figcaption><span>/etc/hdparm.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/dev/disk/by-uuid/1f4a2672-3039-594b-808c-a5d3913b0fde &#123;</span><br><span class="line">        apm = 127</span><br><span class="line">        acoustic_management = 127</span><br><span class="line">        spindown_time = 120</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>/usr/lib/pm-utils/power.d/95hdparm-apm resume</code> 后生效（参考 <code>man hdparm.conf</code>）</p>
<p>其中 <code>spindown_time</code> 参考 <code>man hdparm</code> 中的 <code>-S</code> 选项说明来设置。</p>
<p>不过我的这块硬盘似乎并不按照设定的 <code>spindown_time</code> 来休眠，于是打算观察一段时间 <code>Load_Cycle_Count</code> 的增长情况来决定是否开启休眠功能。</p>
<p><code>smartctl -a /dev/sda | grep Load_Cycle_Count</code> 即可查看。</p>
<h4 id="硬盘无法休眠-Debug"><a href="#硬盘无法休眠-Debug" class="headerlink" title="硬盘无法休眠 Debug"></a>硬盘无法休眠 Debug</h4><p>后来又入了两块盘，但是 <code>hdparm -y</code> 之后又会立即唤醒，无法进入休眠状态。</p>
<p>诊断方式参考：<a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1406434/block-dump-reporting-missing-from-ubuntu-22-04">https://askubuntu.com/questions/1406434/block-dump-reporting-missing-from-ubuntu-22-04</a></p>
<p>监控对 <code>/dev/sda</code> 的使用：<code>blktrace -d /dev/sda -a pc -o - | blkparse -i -</code></p>
<p>然后 <code>hdparm -Y /dev/sda</code> ，查看唤醒磁盘的进程。</p>
<p>我这儿结果如下，然而搜索相关资料后并没有获取到有用的信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">8,16   0        1     0.000000000 18871  D   N 0 [hdparm]</span><br><span class="line">8,16   1        1     0.497835738     0  C   N [0]</span><br><span class="line">8,16   0        2     1.412267626   168  D   R 4 [scsi_eh_1]</span><br><span class="line">8,16   0        3     1.412286261    14  C   R [0]</span><br><span class="line">8,16   0        4     1.412293625    18  D   R 12 [kworker/0:1]</span><br><span class="line">8,16   0        5     1.412295327    14  C   R [0]</span><br><span class="line">8,16   0        6     1.412297439    18  D   R 4 [kworker/0:1]</span><br><span class="line">8,16   0        7     1.412298518    14  C   R [0]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>有可能是 ext4 的 lazy init 导致，参考：<a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/533789/hard-drive-waking-from-sleep-for-no-apparent-reason">https://unix.stackexchange.com/questions/533789/hard-drive-waking-from-sleep-for-no-apparent-reason</a></p>
<h2 id="基于-LXC-安装-OpenWrt"><a href="#基于-LXC-安装-OpenWrt" class="headerlink" title="基于 LXC 安装 OpenWrt"></a>基于 LXC 安装 OpenWrt</h2><p>LXC 开销小，故尝试使用 LXC 安装 OpenWrt</p>
<h3 id="安装-OpenWrt"><a href="#安装-OpenWrt" class="headerlink" title="安装 OpenWrt"></a>安装 OpenWrt</h3><p>安装过程参考：<a target="_blank" rel="noopener" href="https://virtualizeeverything.com/2022/05/23/setting-openwrt-in-proxmox-lxc/">https://virtualizeeverything.com/2022/05/23/setting-openwrt-in-proxmox-lxc/</a></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://downloads.openwrt.org/">https://downloads.openwrt.org/</a></p>
<p>我选择当时最新的稳定版本 22.03.5：<a target="_blank" rel="noopener" href="https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/">https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/</a></p>
<p>下载 <code>rootfs.tar.xz</code> 即可，可以在下载时选择哈希校验。</p>
<p>创建容器的 UI 的文档：<a target="_blank" rel="noopener" href="https://pve.proxmox.com/pve-docs/chapter-pct.html#pct_settings">https://pve.proxmox.com/pve-docs/chapter-pct.html#pct_settings</a></p>
<p>似乎由于 Web 页面无法添加 <code>--ostype unmanaged</code> 参数，需要进入命令行创建：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pct create 101 /var/lib/vz/template/cache/openwrt-22.03.5-x86-64-rootfs.tar.gz --arch amd64 --hostname RaspCloud --rootfs local:1 --memory 1024 --cores 6 --cpuunits 200 --ostype unmanaged --unprivileged 1</span><br></pre></td></tr></table></figure>

<p>然后在 Web UI 中添加一个虚拟网卡 veth0，桥接到 PVE 网桥 vmbr0 上，用于 OpenWrt 和 PVE 的交互。</p>
<p>此时连接在管理口上的设备便和 OpenWrt 连在同一个网桥上了，就可以通过这个虚拟网卡的地址访问 OpenWrt 了。</p>
<p>有可能启动后 veth0 并没被正确配置，可以手动 up 之后使用 IPv6 地址访问。</p>
<p>然后到配置文件 <code>/etc/pve/lxc/101.conf</code> 里添加直通网卡，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lxc.net.0.type: phys</span><br><span class="line">lxc.net.0.link: enp2s0    --- 需要使用的 host 中的网卡名</span><br><span class="line">lxc.net.0.name: eth0      --- LXC 中显示的网卡名</span><br><span class="line">lxc.net.0.flags: up</span><br></pre></td></tr></table></figure>

<p>需要注意 net.id 的 id 不能和 Web UI 中添加的相同。</p>
<p>最终的 conf 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">arch: amd64</span><br><span class="line">cores: 6</span><br><span class="line">cpuunits: 200</span><br><span class="line">hostname: RaspCloud</span><br><span class="line">memory: 1024</span><br><span class="line">net0: name=veth0,bridge=vmbr0,firewall=1,hwaddr=92:81:93:06:8A:7E,type=veth</span><br><span class="line">onboot: 1</span><br><span class="line">ostype: unmanaged</span><br><span class="line">rootfs: local:101/vm-101-disk-1.raw,size=1G</span><br><span class="line">startup: order=1</span><br><span class="line">swap: 512</span><br><span class="line">unprivileged: 1</span><br><span class="line">lxc.net.5.type: phys</span><br><span class="line">lxc.net.5.link: enp2s0</span><br><span class="line">lxc.net.5.name: eth0</span><br><span class="line">lxc.net.5.flags: up</span><br><span class="line">lxc.net.6.type: phys</span><br><span class="line">lxc.net.6.link: enp3s0</span><br><span class="line">lxc.net.6.name: eth1</span><br><span class="line">lxc.net.6.flags: up</span><br><span class="line">lxc.net.7.type: phys</span><br><span class="line">lxc.net.7.link: enp4s0</span><br><span class="line">lxc.net.7.name: eth2</span><br><span class="line">lxc.net.7.flags: up</span><br><span class="line">lxc.net.8.type: phys</span><br><span class="line">lxc.net.8.link: enp5s0</span><br><span class="line">lxc.net.8.name: eth3</span><br><span class="line">lxc.net.8.flags: up</span><br><span class="line">lxc.net.9.type: phys</span><br><span class="line">lxc.net.9.link: enp6s0</span><br><span class="line">lxc.net.9.name: eth4</span><br><span class="line">lxc.net.9.flags: up</span><br></pre></td></tr></table></figure>

<h3 id="配置-OpenWrt"><a href="#配置-OpenWrt" class="headerlink" title="配置 OpenWrt"></a>配置 OpenWrt</h3><h4 id="连接互联网"><a href="#连接互联网" class="headerlink" title="连接互联网"></a>连接互联网</h4><p>由于我需要 OpenWrt 通过 PVE 管理口连接电脑，通过电脑将无线网共享给有线网来访问互联网，所以需要先为 veth0 配置一些上网功能。</p>
<p>添加 Interface veth0，类型为静态地址，网卡设为 veth0，配置好对应的地址，网关和 DNS 服务器地址即可。</p>
<p>之后应该就可以访问网络了。</p>
<h4 id="换源"><a href="#换源" class="headerlink" title="换源"></a>换源</h4><p>参考：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/openwrt/">https://mirrors.tuna.tsinghua.edu.cn/help/openwrt/</a></p>
<h4 id="添加中文"><a href="#添加中文" class="headerlink" title="添加中文"></a>添加中文</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install luci-i18n-base-zh-cn</span><br></pre></td></tr></table></figure>

<h4 id="更改主题"><a href="#更改主题" class="headerlink" title="更改主题"></a>更改主题</h4><p>不大喜欢 OpenWrt 的默认主题，换为 <a target="_blank" rel="noopener" href="https://github.com/jerrykuku/luci-theme-argon/">Argon</a></p>
<p>下载对应的 ipk：<code>https://github.com/jerrykuku/luci-theme-argon/releases/download/v2.3.1/luci-theme-argon_2.3.1_all.ipk</code></p>
<p>然后安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">opkg install luci-compat</span><br><span class="line">opkg install luci-lib-ipkg</span><br><span class="line">opkg install luci-theme-argon*.ipk</span><br></pre></td></tr></table></figure>

<h4 id="配置路由功能"><a href="#配置路由功能" class="headerlink" title="配置路由功能"></a>配置路由功能</h4><p>启动后，只有 wan 和 wan6 两个 Interface，对应 eth0 网口（device）。</p>
<p>计划把其它网口都划入 LAN 中。</p>
<p>首先添加网桥设备 <code>br-lan</code>，把网口都加上去。</p>
<p>然后添加 <code>lan</code> 接口，使用静态地址，把 <code>br-lan</code> 加上去，配置地址即可。</p>
<p>然后发现，似乎 dnsmasq 出现了些问题，无法正常启动。</p>
<p>根据 <a target="_blank" rel="noopener" href="https://github.com/openwrt/openwrt/issues/9064">https://github.com/openwrt/openwrt/issues/9064</a> 中的方法，<code>opkg remove procd-ujail</code> 可以解决。</p>
<p>dnsmasq 正常后，在接口中配置 DHCP &#x2F; DNS 的相关配置，然后 lan 口上接的设备就能获取到分配的地址了。</p>
<p>校园网只会分配 &#x2F;128 地址，故 IPv6 也需要做个 NAT。OpenWrt 中 IPv6 默认并不会配置 SNAT，需要做一些手动配置，参考：<a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/network/ipv6/ipv6.nat6">https://openwrt.org/docs/guide-user/network/ipv6/ipv6.nat6</a></p>
<p>先启用 IPv6 masquerading，其中我这儿的 <code>zone[1]</code> 为 wan 域：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uci <span class="built_in">set</span> firewall.@zone[1].masq6=<span class="string">&quot;1&quot;</span></span><br><span class="line">uci commit firewall</span><br><span class="line">/etc/init.d/firewall restart</span><br></pre></td></tr></table></figure>

<p>然后关闭 wan6 口的 sourcefilter：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uci <span class="built_in">set</span> network.wan6.sourcefilter=<span class="string">&quot;0&quot;</span></span><br><span class="line">uci commit network</span><br><span class="line">/etc/init.d/network restart</span><br></pre></td></tr></table></figure>

<p>这样 lan 口上接的设备也能获取到 DHCPv6 分配的 IPv6 地址了，OpenWrt 也会为其提供 NAT6 服务。</p>
<h4 id="配置-OpenClash"><a href="#配置-OpenClash" class="headerlink" title="配置 OpenClash"></a>配置 OpenClash</h4><p>先卸载 dnsmasq：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg remove dnsmasq</span><br><span class="line"><span class="built_in">mv</span> /etc/config/dhcp /etc/config/dhcp.bak</span><br></pre></td></tr></table></figure>

<p>再按照发布页的说明，先安装依赖，再下载安装 ipk 即可：<a target="_blank" rel="noopener" href="https://github.com/vernesong/OpenClash/releases">https://github.com/vernesong/OpenClash/releases</a></p>
<p>之后按个人喜好配置即可，我选用的是 Meta 核心的 redir-host 模式。</p>
<p>可以将校园网网段设为绕过，减少校内网络访问开销：</p>
<p>IPv4：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">59.66.0.0/16</span><br><span class="line">101.5.0.0/16</span><br><span class="line">101.6.0.0/16</span><br><span class="line">118.229.0.0/19</span><br><span class="line">166.111.0.0/16</span><br><span class="line">183.172.0.0/15</span><br><span class="line">202.112.39.2/32</span><br><span class="line">219.223.168.0/21</span><br><span class="line">219.223.176.0/20</span><br></pre></td></tr></table></figure>

<p>IPv6：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2402:f000::/32</span><br></pre></td></tr></table></figure>

<p>或者可以打开 <code>实验性：绕过中国大陆 IP</code> 功能，减少国内网络访问开销。</p>
<p>遇上 OpenClash 的一个 bug。（<strong>Updated 2023.07.02：</strong> 随着 <code>0.45.128</code> 版本的发布，该问题已得到修复）</p>
<p>在 LuCI 中，虽然已经关闭了 <code>路由本机代理</code>，但是还是会 nftables 中添加处理 Output 链的规则，见 <a target="_blank" rel="noopener" href="https://github.com/vernesong/OpenClash/blob/9ee0f02ed7615a62f960c9ee2f951dd1b47e2411/luci-app-openclash/root/etc/init.d/openclash#LL1649C1-L1672C9">https://github.com/vernesong/OpenClash/blob/9ee0f02ed7615a62f960c9ee2f951dd1b47e2411/luci-app-openclash/root/etc/init.d/openclash#LL1649C1-L1672C9</a>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$enable_redirect_dns</span>&quot;</span> != <span class="string">&quot;2&quot;</span> ] || [ <span class="string">&quot;<span class="variable">$router_self_proxy</span>&quot;</span> = <span class="string">&quot;1&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    nft <span class="string">&#x27;add chain inet fw4 openclash_output&#x27;</span> 2&gt;/dev/null</span><br><span class="line">    nft <span class="string">&#x27;flush chain inet fw4 openclash_output&#x27;</span> 2&gt;/dev/null</span><br><span class="line">    ...</span><br><span class="line">    nft add rule inet fw4 openclash_output ip protocol tcp skuid != 65534 counter redirect to <span class="string">&quot;<span class="variable">$proxy_port</span>&quot;</span> 2&gt;/dev/null</span><br><span class="line">    nft <span class="string">&#x27;add chain inet fw4 nat_output &#123; type nat hook output priority -1; &#125;&#x27;</span> 2&gt;/dev/null</span><br><span class="line">    nft <span class="string">&#x27;add rule inet fw4 nat_output ip protocol tcp counter jump openclash_output&#x27;</span> 2&gt;/dev/null</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>这里的判断中 <strong>或</strong> 上了不使用 Dnsmasq 转发，所以在我的工况下会被启用。暂时未明白为何要这样，故提了 Issue：<a target="_blank" rel="noopener" href="https://github.com/vernesong/OpenClash/issues/3354">https://github.com/vernesong/OpenClash/issues/3354</a>。</p>
<p>两天后作者在 <a target="_blank" rel="noopener" href="https://github.com/vernesong/OpenClash/commit/d49937415c00c6d3f2519a382cd13be54d531e8b">d499374</a> 中修复了该 bug，发布于 <code>0.45.125</code> 版本中，等待合入 master。</p>
<h5 id="远程-Wireshark-抓包调试"><a href="#远程-Wireshark-抓包调试" class="headerlink" title="远程 Wireshark 抓包调试"></a>远程 Wireshark 抓包调试</h5><p>有时配挂了需要抓包调试，可以使用远程主机上的 tcpdump + Windows 本机上的 wireshark 远程抓包分析。</p>
<p>给用户非 root 使用 tcpdump 权限：<code>sudo chmod u+s /usr/sbin/tcpdump</code></p>
<p>然后 Windows 本机执行 <code>ssh ubuntu &quot;tcpdump -i br-lan -l -w - &#39;port not 22&#39;&quot; | wireshark -k -i -</code> 即可开始抓包。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://thiscute.world/posts/tcpdump-and-wireshark">https://thiscute.world/posts/tcpdump-and-wireshark</a></p>
<h5 id="配置-UDP-代理"><a href="#配置-UDP-代理" class="headerlink" title="配置 UDP 代理"></a>配置 UDP 代理</h5><p>使用 Redir-Host 兼容模式 + UDP tproxy 转发似乎并不能正常运行，所以还是得使用 TUN 模式。</p>
<p>LXC 启用 TUN 需要一点额外的配置，参考 <a target="_blank" rel="noopener" href="https://forum.proxmox.com/threads/how-to-enable-tun-tap-in-a-lxc-container.25339/">https://forum.proxmox.com/threads/how-to-enable-tun-tap-in-a-lxc-container.25339/</a>，在配置文件中添加如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lxc.cgroup.devices.allow: c 10:200 rwm</span><br><span class="line">lxc.mount.entry: /dev/net dev/net none bind,create=dir</span><br></pre></td></tr></table></figure>

<p>然后选用 Meta 内核，IPv4 和 IPv6 都启用 TUN 模式，即可代理 UDP 流量了。</p>
<p>还可以考虑开启 <code>仅允许常用端口流量</code> 来防止不必要的代理。具体地，此处所指的常用端口如下：<code>21 22 23 53 80 123 143 194 443 465 587 853 993 995 998 2052 2053 2082 2083 2086 2095 2096 5222 5228 5229 5230 8080 8443 8880 8888 8889</code>。</p>
<h4 id="配置校园网认证"><a href="#配置校园网认证" class="headerlink" title="配置校园网认证"></a>配置校园网认证</h4><p>使用 <a target="_blank" rel="noopener" href="https://github.com/z4yx/GoAuthing">GoAuthing</a>。</p>
<p>新版本的 OpenWrt 配置起来似乎有些不一样的地方，参考 <a target="_blank" rel="noopener" href="https://github.com/z4yx/GoAuthing/issues/30">https://github.com/z4yx/GoAuthing/issues/30</a> 进行修改。</p>
<p>将 <code>goauthing@</code> 脚本放到 <code>/etc/init.d/goauthing</code> 目录下，并 <code>chmod +x</code>。</p>
<figure class="highlight shell"><figcaption><span>/etc/init.d/goauthing</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh /etc/rc.common</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Authenticating utility <span class="keyword">for</span> auth.tsinghua.edu.cn</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This init script is used explicitly with OpenWRT</span></span><br><span class="line"></span><br><span class="line">USE_PROCD=1</span><br><span class="line">START=96</span><br><span class="line">PROG=&quot;/usr/bin/goauthing&quot;</span><br><span class="line">SERV=goauthing  # UCI config at /etc/config/goauthing</span><br><span class="line"></span><br><span class="line">start_instance() &#123;</span><br><span class="line">  local config=$1</span><br><span class="line">  local username password</span><br><span class="line">  config_get username $config username</span><br><span class="line">  config_get password $config password</span><br><span class="line">  local args=&quot;-u $username -p $password&quot;</span><br><span class="line"></span><br><span class="line">  sleep 10 # Wait for link up</span><br><span class="line">  &quot;$PROG&quot; $args deauth</span><br><span class="line">  &quot;$PROG&quot; $args auth</span><br><span class="line">  &quot;$PROG&quot; $args login</span><br><span class="line"></span><br><span class="line">  procd_open_instance</span><br><span class="line">  procd_set_param command &quot;$PROG&quot;</span><br><span class="line">  procd_append_param command $args online</span><br><span class="line">  procd_set_param stderr 1</span><br><span class="line">  procd_set_param respawn</span><br><span class="line">  procd_close_instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logout() &#123;</span><br><span class="line">  local config=$1</span><br><span class="line">  local username password</span><br><span class="line">  config_get username $config username</span><br><span class="line">  config_get password $config password</span><br><span class="line">  local args=&quot;-u $username -p $password&quot;</span><br><span class="line"></span><br><span class="line">  &quot;$PROG&quot; $args logout</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start_service() &#123;</span><br><span class="line">  config_load &quot;$SERV&quot;</span><br><span class="line">  config_foreach start_instance &quot;$SERV&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop_service() &#123;</span><br><span class="line">  config_load &quot;$SERV&quot;</span><br><span class="line">  config_foreach logout &quot;$SERV&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中更改了启动优先级，添加了 <code>sleep 10</code> 来等待 wan 口配置完成，否则会因为无法完成 auth &#x2F; login 就直接进入 online 守护程序，从而一直无法完成登录认证。</p>
<p>然后下载 <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/github-release/z4yx/GoAuthing/LatestRelease/auth-thu.linux.x86_64">https://mirrors.tuna.tsinghua.edu.cn/github-release/z4yx/GoAuthing/LatestRelease/auth-thu.linux.x86_64</a>，并移动至脚本中填写的位置（默认为 <code>/usr/bin/goauthing</code>）。</p>
<p>然后配置并启动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> /etc/config/goauthing</span><br><span class="line">uci add goauthing goauthing</span><br><span class="line">uci <span class="built_in">set</span> goauthing.@goauthing[0].username=<span class="string">&#x27;&lt;YOUR-TUNET-ACCOUNT-NAME&gt;&#x27;</span></span><br><span class="line">uci <span class="built_in">set</span> goauthing.@goauthing[0].password=<span class="string">&#x27;&lt;YOUR-TUNET-PASSWORD&gt;&#x27;</span></span><br><span class="line">uci commit</span><br><span class="line"></span><br><span class="line">/etc/init.d/goauthing <span class="built_in">enable</span></span><br><span class="line">/etc/init.d/goauthing start</span><br></pre></td></tr></table></figure>

<p><strong>20251008 更新：</strong> 上述 <code>goauthing@</code> 脚本会导致进程监测（如 htop）中明文暴露密码，故还是改为使用配置文件方式进行配置，虽然也是明文，但没有那么直接了（）。</p>
<figure class="highlight shell"><figcaption><span>/etc/init.d/goauthing</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh /etc/rc.common</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Authenticating utility <span class="keyword">for</span> auth.tsinghua.edu.cn</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This init script is used explicitly with OpenWRT</span></span><br><span class="line"></span><br><span class="line">USE_PROCD=1</span><br><span class="line">START=96</span><br><span class="line">PROG=&quot;/usr/bin/goauthing&quot;</span><br><span class="line">CONF=&quot;/etc/goauthing.json&quot;</span><br><span class="line"></span><br><span class="line">generate_command() &#123;</span><br><span class="line">  sleep 15 # Wait for link up</span><br><span class="line">CMD=&quot;\</span><br><span class="line">\&quot;$PROG\&quot; -c \&quot;$CONF\&quot; -D deauth; \</span><br><span class="line">sleep 1; \</span><br><span class="line">\&quot;$PROG\&quot; -c \&quot;$CONF\&quot; -D auth; \</span><br><span class="line">sleep 3; \</span><br><span class="line">\&quot;$PROG\&quot; -c \&quot;$CONF\&quot; online; \</span><br><span class="line">&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start_service() &#123;</span><br><span class="line">  generate_command</span><br><span class="line">  procd_open_instance</span><br><span class="line">  procd_set_param command sh</span><br><span class="line">  procd_append_param command -c &quot;$CMD&quot;</span><br><span class="line">  procd_set_param stderr 1</span><br><span class="line">  procd_set_param respawn</span><br><span class="line">  procd_close_instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop_service() &#123;</span><br><span class="line">  &quot;$PROG&quot; -c &quot;$CONF&quot; -D deauth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><figcaption><span>/etc/goauthing.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果后续有服务的启动过程需要已经完成认证，可以添加一个启动项来等待认证完成：</p>
<figure class="highlight shell"><figcaption><span>/etc/init.d/wait_goauthing</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh /etc/rc.common</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Wait <span class="keyword">for</span> goauthing to finish authentication</span></span><br><span class="line"></span><br><span class="line">START=97</span><br><span class="line"></span><br><span class="line">start() &#123;</span><br><span class="line">  echo &quot;Waiting for goauthing to finish authentication...&quot;</span><br><span class="line">  sleep 5</span><br><span class="line">  echo &quot;Goauthing should be done now.&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置链路聚合-AP"><a href="#配置链路聚合-AP" class="headerlink" title="配置链路聚合 AP"></a>配置链路聚合 AP</h4><p>另购置了一台 Wi-Fi 6 无线路由器作为 AP，支持 2x2 MU-MIMO，160 MHz 频宽，理论带宽可达 2402 Mbps。</p>
<p>然而，路由器上只有四个千兆口，连接软路由后跑不到这么高。</p>
<p>不过，这款路由器支持两个端口链路聚合，故尝试配置一下。</p>
<p>首先在路由器上设置两个端口为聚合口，提示：</p>
<blockquote>
<p>端口聚合使用IEEE 802.3ad动态聚合模式，请确保对端设备支持并配置为动态聚合模式。</p>
</blockquote>
<p>然后在 OpenWrt 上安装需要的软件包：<code>opkg install kmod-bonding proto-bonding luci-proto-bonding</code></p>
<p>然后将以下内容添加到 <code>/etc/rc.local</code> 的 <code>exit 0</code> 前：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> add bond-lan <span class="built_in">type</span> bond mode 802.3ad <span class="comment"># 添加 bond 类型的虚拟接口 名称为 bond-lan</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth2 down</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth3 down</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth2 <span class="built_in">type</span> bond_slave            <span class="comment"># 配置网卡模式</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth3 <span class="built_in">type</span> bond_slave</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth2 master bond-lan            <span class="comment"># 加入名称为 bond-lan 的 bond 类型网卡</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth3 master bond-lan</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> bond-lan up                     <span class="comment"># 启动该网卡</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth2 up</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth3 up</span><br><span class="line">brctl addif br-lan bond-lan                 <span class="comment"># 防止有时候无法自动添加到 br-lan 网桥上</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;layer3+4&quot;</span> &gt; /sys/class/net/bond-lan/bonding/xmit_hash_policy</span><br></pre></td></tr></table></figure>

<p>将 <code>eth2</code> 和 <code>eth3</code> 从原来的 <code>br-lan</code> 中移除，添加上 <code>bond-lan</code> 即可。</p>
<p>关于 <code>xmit_hash_policy</code>，默认值为 <code>layer2</code>，会导致单台设备无法打到超过千兆的速度，改为 <code>layer3+4</code> 后可以部分改善。</p>
<p>实测无线可以跑到 1.6 Gbps 左右（后来只能在 UDP 模式下测到 1.4 Gbps 左右了）。</p>
<h4 id="配置防火墙"><a href="#配置防火墙" class="headerlink" title="配置防火墙"></a>配置防火墙</h4><p>官方原版 OpenWrt 默认有一套防火墙策略，简略微调即可。</p>
<h4 id="配置端口转发"><a href="#配置端口转发" class="headerlink" title="配置端口转发"></a>配置端口转发</h4><p>两种方式，一种是基于 iptables 实现，另一种是使用 socat 来转发。</p>
<h5 id="基于-iptables-实现"><a href="#基于-iptables-实现" class="headerlink" title="基于 iptables 实现"></a><strong>基于 iptables 实现</strong></h5><p>OpenWrt 默认的端口转发基于 iptables &#x2F; nftables 实现，然而，配置后发现，在内网无法使用外网地址访问对应端口，初步探索后推测是 NAT 环回时出现问题。</p>
<p>于是在 nftables 中进行调试。</p>
<p>先新建一个表为符合规则的包启用跟踪调试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nft add table inet trace_debug</span><br><span class="line">nft <span class="string">&#x27;add chain inet trace_debug trace_pre &#123; type filter hook prerouting priority -200000; &#125;&#x27;</span></span><br><span class="line">nft insert rule inet trace_debug trace_pre ip saddr 192.168.22.118 ip daddr ??.??.??.?? <span class="built_in">limit</span> rate 1/second meta nftrace <span class="built_in">set</span> 1</span><br></pre></td></tr></table></figure>

<p>然后 <code>nft monitor trace</code> 就可以跟踪了。</p>
<p>跟踪检查后发现，包在 <code>prerouting policy accept</code> 后消失了。</p>
<p>一番摸索后发现，当对应网卡（<code>br-lan</code>）开启混杂模式后，就能正常工作了。</p>
<p>怀疑是 prerouting 后发现目标地址为本地链路地址，于是就修改了目的 mac 地址，导致非混杂模式的网卡将其丢弃。不过简单搜索后也没找到相关的资料。</p>
<h5 id="使用-socat"><a href="#使用-socat" class="headerlink" title="使用 socat"></a><strong>使用 socat</strong></h5><p><strong>Updated 2023.06.29：</strong> 使用 socat 遇到了一些问题，故弃用：</p>
<ul>
<li>会修改源地址，丢失地址数据</li>
<li>UDP 的转发使用 fork 参数存在线程泄漏问题，似乎每个 UDP 包都会 fork 出一个进程且不释放，导致产生大量进程占满内存</li>
</ul>
<p>安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install socat</span><br></pre></td></tr></table></figure>

<p>然后配置端口转发。</p>
<p>例如，配置名为 <code>mc-tcp</code> 的策略，开启，监听本机所有地址的 25565 端口并转发到 192.168.22.3:25565 的配置如下（<code>fork</code> 允许多个连接，<code>reuseaddr</code> 允许 socket 的快速重用，<code>TCP6-LISTEN</code> 也同时监听 IPv4）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uci <span class="built_in">set</span> socat.mc-tcp=socat</span><br><span class="line">uci <span class="built_in">set</span> socat.mc-tcp.enable=1</span><br><span class="line">uci <span class="built_in">set</span> socat.mc-tcp.SocatOptions=<span class="string">&#x27;TCP6-LISTEN:25565,fork,reuseaddr TCP:192.168.22.3:25565&#x27;</span></span><br><span class="line">uci commit</span><br></pre></td></tr></table></figure>

<p>UDP 也类似：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uci <span class="built_in">set</span> socat.mc-udp=socat</span><br><span class="line">uci <span class="built_in">set</span> socat.mc-udp.enable=1</span><br><span class="line">uci <span class="built_in">set</span> socat.mc-udp.SocatOptions=<span class="string">&#x27;UDP6-LISTEN:25565,fork,reuseaddr UDP:192.168.22.3:25565&#x27;</span></span><br><span class="line">uci commit</span><br></pre></td></tr></table></figure>

<p>然后重启 socat 服务即可生效：<code>/etc/init.d/socat restart</code></p>
<p>对外网开放还需在防火墙中允许对应端口的输入。</p>
<h4 id="配置-DDNS"><a href="#配置-DDNS" class="headerlink" title="配置 DDNS"></a>配置 DDNS</h4><p>我的 DNS 解析提供商为 CloudFlare，故安装 <code>ddns-scripts-cloudflare</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opkg install ddns-scripts-cloudflare luci-i18n-ddns-zh-cn</span><br></pre></td></tr></table></figure>

<p>安装完成后在 LuCI 中配置即可，没太大难度。IPv4 和 IPv6 地址需要分别配置。</p>
<h4 id="配置-AdGuard-Home"><a href="#配置-AdGuard-Home" class="headerlink" title="配置 AdGuard Home"></a>配置 AdGuard Home</h4><p>安装 AdGuard Home：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install adguardhome</span><br></pre></td></tr></table></figure>

<p>在 DHCP&#x2F;DNS 的高级设置中，将 DNS 服务器端口改为 53 以外的端口，如 5353。</p>
<p>然后登入 <a target="_blank" rel="noopener" href="http://ip:3000/">http://ip:3000</a> 配置 AdGuard Home，将上游 DNS 服务器设为 OpenClash 设置的 DNS 服务地址，并停用 OpenClash 的 DNS 劫持。</p>
<p>然后应该就可以开始运作了，再添加屏蔽列表即可。</p>
<p>如果需要在 OpenClash 没有正常启动成功的情况下仍可以进行 DNS 服务，则需要设置 fallback DNS 服务器地址。然而目前 AdGuard Home 中并没有这个功能，相关功能 <a target="_blank" rel="noopener" href="https://github.com/AdguardTeam/AdGuardHome/issues/3701">https://github.com/AdguardTeam/AdGuardHome/issues/3701</a> 被设为了 <code>v0.108.0</code> 的目标，希望有生之年能等到 <code>v0.108.0</code> 出来获得这一功能。</p>
<p>（也是因为这个原因，校园网的认证脚本需要配置为 OpenClash 启动完成后再进行认证，感觉怪怪的，所以也暂时放弃了 AdGuard Home）</p>
<h4 id="配置-WireGuard"><a href="#配置-WireGuard" class="headerlink" title="配置 WireGuard"></a>配置 WireGuard</h4><p>安装 <code>WireGuard</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install luci-i18n-wireguard-zh-cn</span><br></pre></td></tr></table></figure>

<p>重启后，在添加接口中就可以找到 WireGuard VPN 了，我添加了一个名为 <code>wg0</code> 的接口。</p>
<p>作为公网 IP 下供其它端来主动连接的一端，我特殊指定了这个接口的监听端口，并在防火墙中运行了该端口的 UDP 访问。</p>
<p>该接口的 IP 地址需要配置为单独的子网，用于各端 VPN 接口间的互相连接。我为其配置了 <code>192.168.23.1/24</code> 和 <code>fd23:41b7:e060::1/64</code> 地址，与 22 网段区别开。</p>
<p>为了方便配置，我没有将这个接口划入单独的区域，而是划入了 lan 区域，共享 lan 区域的防火墙配置。</p>
<p>然后就可以添加对端了。注意 <code>允许的 IP</code> 的这一项中填写 “对端的隧道 IP 地址和对端经由隧道的网络”，对于对端为非路由设备的情况，这一项只填隧道 IP 地址就行，比如 <code>192.168.23.102/32</code>（&#x2F;32 可省略），但不能填写 VPN 接口间的网段，即不能填写 <code>192.168.23.102/24</code>。</p>
<p>各项设置可能需要重启后生效。</p>
<h4 id="之后的计划"><a href="#之后的计划" class="headerlink" title="之后的计划"></a>之后的计划</h4><ul>
<li>配置内网 IP 的域名</li>
<li>配置 MosDNS 优化 DNS 解析（参考：<a target="_blank" rel="noopener" href="https://rushb.pro/article/router-dns.html">https://rushb.pro/article/router-dns.html</a>）</li>
<li>配置 Grafana 可视化路由运行状态、MosDNS 运行数据等</li>
<li>配置 UDP 转发以及游戏优化</li>
</ul>
<h3 id="升级-OpenWrt"><a href="#升级-OpenWrt" class="headerlink" title="升级 OpenWrt"></a>升级 OpenWrt</h3><p>对于软件包的升级，除了可以在 LuCI 中手动逐个升级外，还可以在命令行中先 <code>opkg update</code> 再 <code>opkg list-upgradable | cut -f 1 -d &#39; &#39; | xargs opkg upgrade</code> 来一键升级所有可升级的软件包。</p>
<p>对于系统升级，可以 <code>opkg install luci-app-attendedsysupgrade</code> 后，在 LuCI 中使用 <code>系统</code> -&gt; <code>值守式系统更新</code> 来升级。小版本升级似乎可以保留软件包和配置（装的已经是小版本最新，没试过），但是大版本升级则相当于重新安装了，需要重新配置。</p>
<h2 id="基于-LXC-的其它功能服务器"><a href="#基于-LXC-的其它功能服务器" class="headerlink" title="基于 LXC 的其它功能服务器"></a>基于 LXC 的其它功能服务器</h2><p>其它杂七杂八的服务以及 Docker 就另外开在一个虚拟机上吧。</p>
<p>选用 Debian 12 系统，可以直接从 CT 模板中下载。</p>
<p>参考 <a target="_blank" rel="noopener" href="https://pve.proxmox.com/wiki/Unprivileged_LXC_containers#Using_local_directory_bind_mount_points">https://pve.proxmox.com/wiki/Unprivileged_LXC_containers#Using_local_directory_bind_mount_points</a>，挂载宿主机的共享目录：<code>pct set 100 -mp0 /host/dir,mp=/container/mount/point</code></p>
<p>似乎直接挂载宿主机中的 &#x2F;mnt 的话，即使配置完 UID &#x2F; GID 映射，LXC 容器也并不能正常访问其中宿主机挂载的子目录，可能需要在宿主机 umount 再 mount。所以需要将 mp 指定的目录细化到类似 <code>/mnt/hdd1</code> 这一层。</p>
<p>添加一个虚拟网卡 <code>eth0</code> 桥接到 vmbr0 上，IPv4 选择 DHCP 接收 OpenWrt 的地址分发；而如果 IPv6 选择 DHCP 的话，DHCPv6 是不会通告默认路由的，所以建议选择 SLAAC。</p>
<h3 id="初始配置"><a href="#初始配置" class="headerlink" title="初始配置"></a>初始配置</h3><p>换源，参考：<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/debian/">https://mirrors.tuna.tsinghua.edu.cn/help/debian/</a></p>
<p>添加 sudo，先 <code>apt install sudo</code>，再 <code>echo &quot;username  ALL=(ALL) ALL&quot; | sudo tee /etc/sudoers.d/username</code></p>
<p>默认下终端可能会有乱码，需要配置 UTF-8 语言，<code>sudo dpkg-reconfigure locales</code> 然后选中 <code>en_US.UTF-8</code> 即可。</p>
<h3 id="配置-UID-x2F-GID-映射"><a href="#配置-UID-x2F-GID-映射" class="headerlink" title="配置 UID &#x2F; GID 映射"></a>配置 UID &#x2F; GID 映射</h3><p>如果直接挂载目录共享的话，容器内外会视为不同的用户，导致共享文件时有着麻烦的权限问题。不过我们可以通过 <code>lxc.idmap</code> 来将某一容器中的某些用户映射到 Host 中的某些用户。</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kcore.org/2022/02/05/lxc-subuid-subgid/">https://kcore.org/2022/02/05/lxc-subuid-subgid/</a></li>
<li><a target="_blank" rel="noopener" href="https://pve.proxmox.com/wiki/Unprivileged_LXC_containers">https://pve.proxmox.com/wiki/Unprivileged_LXC_containers</a></li>
<li><a target="_blank" rel="noopener" href="https://itsembedded.com/sysadmin/proxmox_bind_unprivileged_lxc/">https://itsembedded.com/sysadmin/proxmox_bind_unprivileged_lxc/</a></li>
</ul>
<p>以下以映射 102 容器中的 1000 用户为 Host 中的 1000 用户为例：</p>
<p>先在 <code>/etc/subuid</code> 和 <code>/etc/subgid</code> 中都添加上 <code>root:1000:1</code>，来允许 root 创建到 1000 用户的映射。</p>
<p>然后在 <code>/etc/pve/lxc/102.conf</code> 的配置文件中，添加如下内容：</p>
<figure class="highlight plaintext"><figcaption><span>/etc/pve/lxc/102.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lxc.idmap: u 0 100000 1000</span><br><span class="line">lxc.idmap: g 0 100000 1000</span><br><span class="line">lxc.idmap: u 1000 1000 1</span><br><span class="line">lxc.idmap: g 1000 1000 1</span><br><span class="line">lxc.idmap: u 1001 101000 64535</span><br><span class="line">lxc.idmap: g 1001 101000 64535</span><br></pre></td></tr></table></figure>

<p>建议将原来容器内 1000 映射到的 101000 用户还包含在映射范围内，这样容器内的 root 才能够将文件的所有权从原先的转到现在的。</p>
<h3 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h3><p>由于并不想在 PVE 中直接装 Docker，故在 Debian 虚拟机中安装 Docker。</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/debian/#install-using-the-convenience-script">https://docs.docker.com/engine/install/debian/#install-using-the-convenience-script</a></li>
<li><a target="_blank" rel="noopener" href="https://yeasy.gitbook.io/docker_practice/install/debian">https://yeasy.gitbook.io/docker_practice/install/debian</a></li>
</ul>
<p>安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line">sudo sh get-docker.sh</span><br></pre></td></tr></table></figure>

<p>加入 Docker 用户组，在无 root 权限下使用 Docker：<code>sudo usermod -aG docker $USER</code></p>
<p>验证安装正确性：<code>docker run --rm hello-world</code></p>
<p>如没有方便的网络接入，配置镜像参考：<a target="_blank" rel="noopener" href="https://yeasy.gitbook.io/docker_practice/install/mirror">https://yeasy.gitbook.io/docker_practice/install/mirror</a></p>
<p>在 LXC 容器启动后，Docker 会过一两分钟才会启动，暂时不知道原因为何。</p>
<h3 id="Docker-启用-IPv6-支持"><a href="#Docker-启用-IPv6-支持" class="headerlink" title="Docker 启用 IPv6 支持"></a>Docker 启用 IPv6 支持</h3><p>由于挂的 PT 需要有 IPv6 接入，故需要给 Docker 开启 IPv6。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://docs.docker.com/config/daemon/ipv6/">https://docs.docker.com/config/daemon/ipv6/</a></p>
<p>编辑配置文件：</p>
<figure class="highlight json"><figcaption><span>/etc/docker/daemon.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip6tables&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后重启 Docker：<code>sudo systemctl restart docker</code></p>
<p>启动容器时，需要额外的配置。如果使用 Docker Compose，则添加如下内容，并在对应 service 配置中添加 networks 即可：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">ip6net:</span></span><br><span class="line">    <span class="attr">enable_ipv6:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">subnet:</span> <span class="number">2001</span><span class="string">:0DB8::/112</span></span><br></pre></td></tr></table></figure>

<p><code>netstat -tunlp</code> 可以查看监听端口，若对应的端口只有 tcp6 在监听也不用慌张，若 <code>cat /proc/sys/net/ipv6/bindv6only</code> 为 0 则表明已在双栈上监听，参考（<a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/496137/does-80-in-netstat-output-means-only-ipv6-or-ipv6ipv4">https://unix.stackexchange.com/questions/496137/does-80-in-netstat-output-means-only-ipv6-or-ipv6ipv4</a>）</p>
<h3 id="配置-PT-客户端"><a href="#配置-PT-客户端" class="headerlink" title="配置 PT 客户端"></a>配置 PT 客户端</h3><p>使用 <a target="_blank" rel="noopener" href="https://hub.docker.com/r/linuxserver/transmission">linuxserver&#x2F;transmission</a> Docker 镜像。</p>
<p>使用 Docker Compose 来配置容器，按说明编写配置文件：</p>
<figure class="highlight yml"><figcaption><span>docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&quot;2.1&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">transmission:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">lscr.io/linuxserver/transmission:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">transmission</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PUID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PGID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TRANSMISSION_WEB_HOME=/config/transmission-web-control/src</span> <span class="comment">#optional</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">USER=thx</span> <span class="comment">#optional</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">FILE__PASS=/config/password</span> <span class="comment">#optional</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WHITELIST=</span> <span class="comment">#optional</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PEERPORT=</span> <span class="comment">#optional</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HOST_WHITELIST=</span> <span class="comment">#optional</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/thx/Service/transmission/config:/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/PT:/downloads</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/PT/torrentwatch:/watch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt:/mnt</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9091</span><span class="string">:9091</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">51413</span><span class="string">:51413</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">51413</span><span class="string">:51413/udp</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ip6net</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">ip6net:</span></span><br><span class="line">    <span class="attr">enable_ipv6:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">2001</span><span class="string">:0DB8:1::/112</span></span><br></pre></td></tr></table></figure>

<p>其中 UID &#x2F; GID 可以参考 <code>id $user</code> 的结果设置。</p>
<p>生成密钥文件时不能有行末符，可以这样生成：<code>echo -n password_in_clear_text &gt; password</code></p>
<p>Web UI 使用 <a target="_blank" rel="noopener" href="https://github.com/ronggang/transmission-web-control">transmission-web-control</a>，在 <code>/config</code> 对应的目录下 git clone 即可。</p>
<p>迁移之前的种子和配置只需要将之前的 <code>config</code> 目录移过来即可，如果之前是裸机安装，目录可能在 <code>/var/lib/transmission-daemon/info</code></p>
<p>还要记得在路由器上配置 51413 端口的 TCP &amp; UDP 转发。</p>
<p>配完端口转发，查看防火墙规则链可知，无需再在通信规则中开放端口。</p>
<h4 id="运行方法"><a href="#运行方法" class="headerlink" title="运行方法"></a>运行方法</h4><p>创建 container 并启动后台运行：<code>docker compose up -d</code></p>
<p>停止并删除 container 和对应的网络：<code>docker compose down</code></p>
<p>启动 &#x2F; 停止 对应的 container：<code>docker compose start</code> &#x2F; <code>docker compose stop</code></p>
<p>更新：先 <code>docker-compose pull</code>，然后 <code>docker compose down</code> 和 <code>docker compose up -d</code></p>
<p>清理无用镜像：<code>docker image prune</code></p>
<h3 id="配置-Syncthing-同步服务"><a href="#配置-Syncthing-同步服务" class="headerlink" title="配置 Syncthing 同步服务"></a>配置 Syncthing 同步服务</h3><p>使用 <a target="_blank" rel="noopener" href="https://hub.docker.com/r/linuxserver/syncthing">linuxserver&#x2F;syncthing</a> Docker 镜像。</p>
<p>使用 Docker Compose 来配置容器，按说明编写配置文件。</p>
<p>由于 Syncthing 需要发送本地组播包来进行本地链路上的节点发现，故这里将网络模式修改为 host 模式，参考：<a target="_blank" rel="noopener" href="https://github.com/syncthing/syncthing/blob/main/README-Docker.md#discovery">https://github.com/syncthing/syncthing/blob/main/README-Docker.md#discovery</a>。</p>
<figure class="highlight yml"><figcaption><span>docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&quot;2.1&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">syncthing:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">lscr.io/linuxserver/syncthing:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">syncthing</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">RaspCloud</span> <span class="comment">#optional</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PUID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PGID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/thx/Service/syncthing/config:/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt:/mnt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data:/data</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure>

<p>还要记得在路由器上配置 22000 端口的 TCP &amp; UDP 转发。</p>
<p>运行方法同上。</p>
<h3 id="配置蓝牙监听服务"><a href="#配置蓝牙监听服务" class="headerlink" title="配置蓝牙监听服务"></a>配置蓝牙监听服务</h3><p>之前 <a href="/2022/09/07/%E4%BD%BF%E7%94%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E5%92%8C%E5%B0%8F%E7%B1%B3%E8%93%9D%E7%89%99%E6%B8%A9%E6%B9%BF%E5%BA%A6%E8%AE%A1%E5%8F%AF%E8%A7%86%E5%8C%96%E5%AE%BF%E8%88%8D%E6%B8%A9%E6%B9%BF%E5%BA%A6%E5%8F%98%E5%8C%96">使用树莓派和小米蓝牙温湿度计可视化宿舍温湿度变化</a> 中配置了蓝牙接收温湿度计数据，也把这个服务迁移过来。</p>
<p>花费十元购入了 BR8651 芯片的 USB 蓝牙 5.1 适配器，据说该芯片在 Linux 下有驱动。</p>
<p>可能是因为芯片较新的原因，各方面的支持似乎都还不太好，尝试了几个方法都没能正常地使用脚本获取 BLE Advertising，这里记录了几次失败的过程。</p>
<h4 id="配置-LXC-的-USB-直通"><a href="#配置-LXC-的-USB-直通" class="headerlink" title="配置 LXC 的 USB 直通"></a>配置 LXC 的 USB 直通</h4><p>本来想在 LXC 容器中配置蓝牙服务，但是 <code>hciconfig</code> 会报错 <code>Can&#39;t open HCI socket.: Address family not supported by protocol</code>，查阅资料后发现，由于蓝牙将自身注册为网络接口，所以并不能像使用 USB 那样将蓝牙设备传给 LXC 容器，参考：<a target="_blank" rel="noopener" href="https://forum.proxmox.com/threads/assign-a-bluetooth-dongle-to-a-ct.67577/">https://forum.proxmox.com/threads/assign-a-bluetooth-dongle-to-a-ct.67577/</a>。</p>
<p>所以以下部分只是记录如何直通 USB 设备。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://medium.com/@konpat/usb-passthrough-to-an-lxc-proxmox-15482674f11d">https://medium.com/@konpat/usb-passthrough-to-an-lxc-proxmox-15482674f11d</a></p>
<p>直接在 LXC 中 <code>lsusb</code> 是可以看到各个 USB 设备的，但是无法使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Bus 004 Device 002: ID 174c:3074 ASMedia Technology Inc. ASM1074 SuperSpeed hub</span><br><span class="line">Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub</span><br><span class="line">Bus 003 Device 003: ID 05e3:0751 Genesys Logic, Inc. microSD Card Reader</span><br><span class="line">Bus 003 Device 004: ID 0a12:0001 Cambridge Silicon Radio, Ltd Bluetooth Dongle (HCI mode)</span><br><span class="line">Bus 003 Device 002: ID 174c:2074 ASMedia Technology Inc. ASM1074 High-Speed hub</span><br><span class="line">Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span><br><span class="line">Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub</span><br><span class="line">Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span><br></pre></td></tr></table></figure>

<p>关注其中的 Bluetooth 设备，位于 <code>Bus 003 Device 004</code>。</p>
<p>查看其主次设备号：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@pve:/etc/pve/lxc# ls -al /dev/bus/usb/003/004</span><br><span class="line">crw-rw-r-- 1 root root 189, 259 Jul  1 00:28 /dev/bus/usb/003/004</span><br></pre></td></tr></table></figure>

<p>主设备号为 189，向配置文件中添加以下内容，将设备映射到容器内：</p>
<figure class="highlight plaintext"><figcaption><span>/etc/pve/lxc/102.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lxc.cgroup.devices.allow: c 189:* rwm</span><br><span class="line">lxc.mount.entry: /dev/bus/usb/003/004 dev/bus/usb/003/004 none bind,optional,create=file</span><br></pre></td></tr></table></figure>

<p>或者直接将目录映射过去也行，防止设备名发生变化：</p>
<figure class="highlight plaintext"><figcaption><span>/etc/pve/lxc/102.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lxc.mount.entry: /dev/bus/usb/003 dev/bus/usb/003 none bind,optional,create=dir</span><br></pre></td></tr></table></figure>

<p>如果容器中 <code>ls -al /dev/bus/usb/003/004</code> 权限不对（<code>nobody</code> &#x2F; <code>nogroup</code>），可以在 PVE 中 <code>chown 100000:100000 /dev/bus/usb/003/004</code>，这样容器中就为 <code>root</code> 权限了。</p>
<h4 id="在宿主机中直接配置蓝牙"><a href="#在宿主机中直接配置蓝牙" class="headerlink" title="在宿主机中直接配置蓝牙"></a>在宿主机中直接配置蓝牙</h4><p>由于不想再单独开一台虚拟机，故打算在宿主机中直接运行蓝牙监听服务。</p>
<p>正好宿主机中也有一个非 root 用户，使用这个用户来运行服务，尽量减小对系统的影响。</p>
<p>先验证蓝牙功能是否正常，在 <code>bluetoothctl</code> 中运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">menu scan</span><br><span class="line">transport le</span><br><span class="line">back</span><br><span class="line">scan on</span><br></pre></td></tr></table></figure>

<p>应该能够看到一些广播和数据。</p>
<p>（我这儿 <code>hcitool lescan</code> 会报错 <code>Set scan parameters failed: Input/output error</code>，参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/70777475/hcitool-lescan-returns-an-i-o-error-on-manjaro">https://stackoverflow.com/questions/70777475/hcitool-lescan-returns-an-i-o-error-on-manjaro</a> 发现如上使用 <code>bluetoothctl</code> 就能正常工作）</p>
<h5 id="非特权安装-pip3"><a href="#非特权安装-pip3" class="headerlink" title="非特权安装 pip3"></a>非特权安装 pip3</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://bootstrap.pypa.io/get-pip.py</span><br><span class="line">python3 get-pip.py --user</span><br></pre></td></tr></table></figure>

<p>如果报错 <code>ModuleNotFoundError: No module named &#39;distutils.cmd&#39;</code>，则需要安装 <code>python3-distutils</code></p>
<h5 id="安装运行-MiTemperature2"><a href="#安装运行-MiTemperature2" class="headerlink" title="安装运行 MiTemperature2"></a>安装运行 MiTemperature2</h5><p>按照 <a target="_blank" rel="noopener" href="https://github.com/JsBergbau/MiTemperature2">MiTemperature2</a> 文档进行安装。</p>
<p>安装 <code>bluepy</code> 前需要先安装 <code>libglib2.0-dev</code></p>
<p>安装 <code>pybluez</code> 时可能遇到 <code>error in PyBluez setup command: use_2to3 is invalid.</code> 的问题，参考 <a target="_blank" rel="noopener" href="https://github.com/pybluez/pybluez/issues/467">https://github.com/pybluez/pybluez/issues/467</a>，先 <code>pip3 install setuptools==58</code> 再安装即可。</p>
<p>之后遇到类似 <a target="_blank" rel="noopener" href="https://github.com/JsBergbau/MiTemperature2/issues/106">https://github.com/JsBergbau/MiTemperature2/issues/106</a> 的问题，以及类似 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/75175755/not-seeing-ble-device-advertising-unless-set-bluetoothctl-transport-le">https://stackoverflow.com/questions/75175755/not-seeing-ble-device-advertising-unless-set-bluetoothctl-transport-le</a> 的问题，都暂时没有被解决。</p>
<p>于是也放弃了。</p>
<h3 id="配置-MC-服务器"><a href="#配置-MC-服务器" class="headerlink" title="配置 MC 服务器"></a>配置 MC 服务器</h3><h4 id="安装-Java-8"><a href="#安装-Java-8" class="headerlink" title="安装 Java 8"></a>安装 Java 8</h4><p>由于该整合包版本需要 Java 8，而 Debian 官方源中没有，故使用第三方源安装。</p>
<p>准备工作：<code>sudo apt install apt-transport-https ca-certificates wget dirmngr gnupg software-properties-common</code></p>
<p>添加第三方源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -qO - https://adoptopenjdk.jfrog.io/adoptopenjdk/api/gpg/key/public | sudo <span class="built_in">tee</span> /etc/apt/trusted.gpg.d/adoptopenjdk.asc</span><br><span class="line">sudo add-apt-repository --<span class="built_in">yes</span> https://adoptopenjdk.jfrog.io/adoptopenjdk/deb/</span><br></pre></td></tr></table></figure>

<p>由于 adoptopenjdk 可能还没加上 bookworm 源，可能需要手动将源中的 <code>bookworm</code> 改为 <code>bullseye</code>。</p>
<p>安装 Java 8 JRE：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install adoptopenjdk-8-hotspot-jre</span><br></pre></td></tr></table></figure>

<h4 id="添加为服务"><a href="#添加为服务" class="headerlink" title="添加为服务"></a>添加为服务</h4><p>添加为 systemd 服务，参考 <a target="_blank" rel="noopener" href="https://gist.github.com/winny-/bb17853ffc76fbb9b039">https://gist.github.com/winny-/bb17853ffc76fbb9b039</a> 进行修改。</p>
<figure class="highlight ini"><figcaption><span>/etc/systemd/system/minecraft.service</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Minecraft Server</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">WorkingDirectory</span>=/data/MC/RAD2-<span class="number">1.3</span>/RAD2-Serverpack-<span class="number">1.3</span></span><br><span class="line"><span class="attr">User</span>=thx</span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">ExitType</span>=cgroup</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/tmux new-session -s mc -d <span class="string">&#x27;./LaunchServer.sh&#x27;</span></span><br><span class="line"><span class="attr">ExecStop</span>=/usr/bin/tmux send-keys -t mc:<span class="number">0.0</span> <span class="string">&#x27;say SERVER SHUTTING DOWN. Saving map...&#x27;</span> C-m <span class="string">&#x27;save-all&#x27;</span> C-m <span class="string">&#x27;stop&#x27;</span> C-m</span><br><span class="line"><span class="attr">ExecStop</span>=/bin/sleep <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<p>使用 <code>Type=forking</code> 来管理 <code>tmux new-session</code> fork 出的进程。</p>
<p>使用 <code>ExitType=cgroup</code> 等待所有程序退出。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>基于 Proxmox VE 的 All in One 服务器搭建</p><p><a href="https://blog.centaurus99.com/2023/06/17/基于-Proxmox-VE-的-All-in-One-服务器搭建/">https://blog.centaurus99.com/2023/06/17/基于-Proxmox-VE-的-All-in-One-服务器搭建/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Centaurus99</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2023-06-17</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-10-08</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-creative-commons"></i> <i class="fab fa-creative-commons-by"></i> <i class="fab fa-creative-commons-nc"></i> <i class="fab fa-creative-commons-sa"></i>  </a><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0 </a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/%E8%BD%AF%E8%B7%AF%E7%94%B1/">软路由, </a><a class="link-muted" rel="tag" href="/tags/PVE/">PVE </a></div></div><!--!--></article></div><!--!--><div class="card"><nav class="post-navigation mt-4 level is-mobile card-content"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/09/07/%E4%BD%BF%E7%94%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E5%92%8C%E5%B0%8F%E7%B1%B3%E8%93%9D%E7%89%99%E6%B8%A9%E6%B9%BF%E5%BA%A6%E8%AE%A1%E5%8F%AF%E8%A7%86%E5%8C%96%E5%AE%BF%E8%88%8D%E6%B8%A9%E6%B9%BF%E5%BA%A6%E5%8F%98%E5%8C%96/"><span class="level-item">使用树莓派和小米蓝牙温湿度计可视化宿舍温湿度变化</span><i class="level-item fas fa-chevron-right"></i></a></div></nav></div><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="waline-thread"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/waline/2.6.3/waline.css"><script src="https://cdnjs.loli.net/ajax/libs/waline/2.6.3/waline.js"></script><script>Waline.init({
            el: '#waline-thread',
            serverURL: "https://waline.centaurus99.com",
            path: window.location.pathname,
            lang: "zh-CN",
            
            emoji: ["https://cdn.jsdelivr.net/gh/walinejs/emojis@1.1.0/alus","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.1.0/bilibili","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.1.0/qq","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.1.0/tieba","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.1.0/tw-emoji","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.1.0/weibo"],
            dark: "body.night",
            meta: ["nick","mail","link"],
            requiredMeta: [],
            login: "enable",
            
            pageSize: 10,
            imageUploader: false,
            highlighter: false,
            texRenderer: false,
            search: false,
            pageview: false,
            comment: false,
            copyright: true,
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level" style="margin-bottom:1rem"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/gravatar.jpg" alt="Centaurus99"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Centaurus99</p></div></div></nav><nav class="level menu-list is-mobile" style="margin-bottom:1rem"><a class="level-item has-text-centered is-marginless" href="/archives/"><div><p class="heading">文章</p><div><p class="title">8</p></div></div></a><a class="level-item has-text-centered is-marginless" href="/categories/"><div><p class="heading">分类</p><div><p class="title">3</p></div></div></a><a class="level-item has-text-centered is-marginless" href="/tags/"><div><p class="heading">标签</p><div><p class="title">10</p></div></div></a></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Centaurus99" target="_blank" rel="noopener"><i class="fab fa-github"></i>  关注</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Centaurus99"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#整体配置概览"><span class="level-left"><span class="level-item">1</span><span class="level-item">整体配置概览</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#软路由"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">软路由</span></span></a></li><li><a class="level is-mobile" href="#无线-AP"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">无线 AP</span></span></a></li></ul></li><li><a class="level is-mobile" href="#安装和调试-PVE"><span class="level-left"><span class="level-item">2</span><span class="level-item">安装和调试 PVE</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#安装"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">安装</span></span></a></li><li><a class="level is-mobile" href="#更换内核版本"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">更换内核版本</span></span></a></li><li><a class="level is-mobile" href="#管理页面添加温度显示"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">管理页面添加温度显示</span></span></a></li><li><a class="level is-mobile" href="#删除-lvm-thin-并扩容-lvm"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">删除 lvm-thin 并扩容 lvm</span></span></a></li><li><a class="level is-mobile" href="#部署-samba"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">部署 samba</span></span></a></li><li><a class="level is-mobile" href="#更改-CPU-电源策略"><span class="level-left"><span class="level-item">2.6</span><span class="level-item">更改 CPU 电源策略</span></span></a></li><li><a class="level is-mobile" href="#无显示器启动问题"><span class="level-left"><span class="level-item">2.7</span><span class="level-item">无显示器启动问题</span></span></a></li><li><a class="level is-mobile" href="#挂载硬盘"><span class="level-left"><span class="level-item">2.8</span><span class="level-item">挂载硬盘</span></span></a></li><li><a class="level is-mobile" href="#硬盘维护"><span class="level-left"><span class="level-item">2.9</span><span class="level-item">硬盘维护</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#缩减数据盘的文件系统预留空间"><span class="level-left"><span class="level-item">2.9.1</span><span class="level-item">缩减数据盘的文件系统预留空间</span></span></a></li><li><a class="level is-mobile" href="#S-M-A-R-T-信息"><span class="level-left"><span class="level-item">2.9.2</span><span class="level-item">S.M.A.R.T. 信息</span></span></a></li><li><a class="level is-mobile" href="#配置-smartd-守护程序"><span class="level-left"><span class="level-item">2.9.3</span><span class="level-item">配置 smartd 守护程序</span></span></a></li><li><a class="level is-mobile" href="#配置硬盘休眠"><span class="level-left"><span class="level-item">2.9.4</span><span class="level-item">配置硬盘休眠</span></span></a></li><li><a class="level is-mobile" href="#硬盘无法休眠-Debug"><span class="level-left"><span class="level-item">2.9.5</span><span class="level-item">硬盘无法休眠 Debug</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#基于-LXC-安装-OpenWrt"><span class="level-left"><span class="level-item">3</span><span class="level-item">基于 LXC 安装 OpenWrt</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#安装-OpenWrt"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">安装 OpenWrt</span></span></a></li><li><a class="level is-mobile" href="#配置-OpenWrt"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">配置 OpenWrt</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#连接互联网"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">连接互联网</span></span></a></li><li><a class="level is-mobile" href="#换源"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">换源</span></span></a></li><li><a class="level is-mobile" href="#添加中文"><span class="level-left"><span class="level-item">3.2.3</span><span class="level-item">添加中文</span></span></a></li><li><a class="level is-mobile" href="#更改主题"><span class="level-left"><span class="level-item">3.2.4</span><span class="level-item">更改主题</span></span></a></li><li><a class="level is-mobile" href="#配置路由功能"><span class="level-left"><span class="level-item">3.2.5</span><span class="level-item">配置路由功能</span></span></a></li><li><a class="level is-mobile" href="#配置-OpenClash"><span class="level-left"><span class="level-item">3.2.6</span><span class="level-item">配置 OpenClash</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#远程-Wireshark-抓包调试"><span class="level-left"><span class="level-item">3.2.6.1</span><span class="level-item">远程 Wireshark 抓包调试</span></span></a></li><li><a class="level is-mobile" href="#配置-UDP-代理"><span class="level-left"><span class="level-item">3.2.6.2</span><span class="level-item">配置 UDP 代理</span></span></a></li></ul></li><li><a class="level is-mobile" href="#配置校园网认证"><span class="level-left"><span class="level-item">3.2.7</span><span class="level-item">配置校园网认证</span></span></a></li><li><a class="level is-mobile" href="#配置链路聚合-AP"><span class="level-left"><span class="level-item">3.2.8</span><span class="level-item">配置链路聚合 AP</span></span></a></li><li><a class="level is-mobile" href="#配置防火墙"><span class="level-left"><span class="level-item">3.2.9</span><span class="level-item">配置防火墙</span></span></a></li><li><a class="level is-mobile" href="#配置端口转发"><span class="level-left"><span class="level-item">3.2.10</span><span class="level-item">配置端口转发</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#基于-iptables-实现"><span class="level-left"><span class="level-item">3.2.10.1</span><span class="level-item">基于 iptables 实现</span></span></a></li><li><a class="level is-mobile" href="#使用-socat"><span class="level-left"><span class="level-item">3.2.10.2</span><span class="level-item">使用 socat</span></span></a></li></ul></li><li><a class="level is-mobile" href="#配置-DDNS"><span class="level-left"><span class="level-item">3.2.11</span><span class="level-item">配置 DDNS</span></span></a></li><li><a class="level is-mobile" href="#配置-AdGuard-Home"><span class="level-left"><span class="level-item">3.2.12</span><span class="level-item">配置 AdGuard Home</span></span></a></li><li><a class="level is-mobile" href="#配置-WireGuard"><span class="level-left"><span class="level-item">3.2.13</span><span class="level-item">配置 WireGuard</span></span></a></li><li><a class="level is-mobile" href="#之后的计划"><span class="level-left"><span class="level-item">3.2.14</span><span class="level-item">之后的计划</span></span></a></li></ul></li><li><a class="level is-mobile" href="#升级-OpenWrt"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">升级 OpenWrt</span></span></a></li></ul></li><li><a class="level is-mobile" href="#基于-LXC-的其它功能服务器"><span class="level-left"><span class="level-item">4</span><span class="level-item">基于 LXC 的其它功能服务器</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#初始配置"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">初始配置</span></span></a></li><li><a class="level is-mobile" href="#配置-UID-x2F-GID-映射"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">配置 UID / GID 映射</span></span></a></li><li><a class="level is-mobile" href="#安装-Docker"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">安装 Docker</span></span></a></li><li><a class="level is-mobile" href="#Docker-启用-IPv6-支持"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">Docker 启用 IPv6 支持</span></span></a></li><li><a class="level is-mobile" href="#配置-PT-客户端"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">配置 PT 客户端</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#运行方法"><span class="level-left"><span class="level-item">4.5.1</span><span class="level-item">运行方法</span></span></a></li></ul></li><li><a class="level is-mobile" href="#配置-Syncthing-同步服务"><span class="level-left"><span class="level-item">4.6</span><span class="level-item">配置 Syncthing 同步服务</span></span></a></li><li><a class="level is-mobile" href="#配置蓝牙监听服务"><span class="level-left"><span class="level-item">4.7</span><span class="level-item">配置蓝牙监听服务</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#配置-LXC-的-USB-直通"><span class="level-left"><span class="level-item">4.7.1</span><span class="level-item">配置 LXC 的 USB 直通</span></span></a></li><li><a class="level is-mobile" href="#在宿主机中直接配置蓝牙"><span class="level-left"><span class="level-item">4.7.2</span><span class="level-item">在宿主机中直接配置蓝牙</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#非特权安装-pip3"><span class="level-left"><span class="level-item">4.7.2.1</span><span class="level-item">非特权安装 pip3</span></span></a></li><li><a class="level is-mobile" href="#安装运行-MiTemperature2"><span class="level-left"><span class="level-item">4.7.2.2</span><span class="level-item">安装运行 MiTemperature2</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#配置-MC-服务器"><span class="level-left"><span class="level-item">4.8</span><span class="level-item">配置 MC 服务器</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#安装-Java-8"><span class="level-left"><span class="level-item">4.8.1</span><span class="level-item">安装 Java 8</span></span></a></li><li><a class="level is-mobile" href="#添加为服务"><span class="level-left"><span class="level-item">4.8.2</span><span class="level-item">添加为服务</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Centaurus99 的杂物堆</a><p class="is-size-7"><span>&copy; 2025 Centaurus99</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-creative-commons"></i> <i class="fab fa-creative-commons-by"></i> <i class="fab fa-creative-commons-nc"></i> <i class="fab fa-creative-commons-sa"></i> </a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/Centaurus99/centaurus99.github.io"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.15.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.15.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.15.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.15.1/contrib/mhchem.min.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>